<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Chọn môn - Duy Tien</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>

  <div class="app-container">
    <nav class="navbar">
      <div class="nav-inner">
        <a href="index.html" class="nav-back"><i class="fas fa-chevron-left"></i></a>
        <span class="nav-title">Chọn môn</span>
        <div class="nav-placeholder"></div>
      </div>
    </nav>

    <main class="content">

      <section class="leaderboard glass-panel" aria-label="Bảng xếp hạng">
        <div class="lb-head">
          <div class="lb-title">Bảng xếp hạng</div>
          <div class="lb-sub">Top 3 người làm nhiều nhất</div>
        </div>

        <div id="lbLoading" class="lb-loading">Đang tải...</div>

        <div id="lbEmpty" class="lb-empty hidden">
          Chưa có dữ liệu. Hãy làm bài để lên top!
        </div>

        <div id="lbList" class="lb-list hidden"></div>
      </section>

      <div class="header">
        <h1>Chọn môn học</h1>
        <p>Chạm để vào đúng trang môn bạn cần.</p>
      </div>

      <div class="section">
        <div class="section-label">MÔN HỌC</div>

        <div class="grid-subject">
          <div class="subject-card ripple" onclick="goToSubject('https://cuoiky-lichsu.pages.dev/mode')">
            <div class="subject-top">
              <i class="fas fa-landmark icon-sm"></i>
              <span class="pill">Môn</span>
            </div>
            <div class="subject-main">
              <div class="subject-name">Lịch sử</div>
              <div class="subject-sub">Vào chế độ</div>
            </div>
            <div class="subject-foot">
              <span class="subject-link">Mở</span>
              <i class="fas fa-arrow-right arrow"></i>
            </div>
          </div>

          <div class="subject-card ripple" onclick="goToSubject('https://cuoiky-sinhhoc.pages.dev/mode')">
            <div class="subject-top">
              <i class="fas fa-dna icon-sm"></i>
              <span class="pill">Môn</span>
            </div>
            <div class="subject-main">
              <div class="subject-name">Sinh Học</div>
              <div class="subject-sub">Vào chế độ</div>
            </div>
            <div class="subject-foot">
              <span class="subject-link">Mở</span>
              <i class="fas fa-arrow-right arrow"></i>
            </div>
          </div>

          <div class="subject-card ripple" onclick="goToSubject('https://cuoiky-tinhoc.pages.dev/mode')">
            <div class="subject-top">
              <i class="fas fa-microchip icon-sm"></i>
              <span class="pill">Môn</span>
            </div>
            <div class="subject-main">
              <div class="subject-name">Tin Học</div>
              <div class="subject-sub">Vào chế độ</div>
            </div>
            <div class="subject-foot">
              <span class="subject-link">Mở</span>
              <i class="fas fa-arrow-right arrow"></i>
            </div>
          </div>

          <div class="subject-card ripple" onclick="goToSubject('https://cuoiky-tienganh.pages.dev/mode')">
            <div class="subject-top">
              <i class="fas fa-language icon-sm"></i>
              <span class="pill">Môn</span>
            </div>
            <div class="subject-main">
              <div class="subject-name">Tiếng Anh</div>
              <div class="subject-sub">Nhóm Không Chọn</div>
            </div>
            <div class="subject-foot">
              <span class="subject-link">Mở</span>
              <i class="fas fa-arrow-right arrow"></i>
            </div>
          </div>

          <div class="subject-card ripple" onclick="goToSubject('https://cuoiky-tienganh-chon.pages.dev/mode')">
            <div class="subject-top">
              <i class="fas fa-language icon-sm"></i>
              <span class="pill">Môn</span>
            </div>
            <div class="subject-main">
              <div class="subject-name">Tiếng Anh</div>
              <div class="subject-sub">Nhóm Có Chọn</div>
            </div>
            <div class="subject-foot">
              <span class="subject-link">Mở</span>
              <i class="fas fa-arrow-right arrow"></i>
            </div>
          </div>

          <!-- Môn mới thêm vào vị trí cuối -->
          <div class="subject-card ripple" onclick="goToSubject('https://trac-nghiem.pages.dev/mode')">
            <div class="subject-top">
              <i class="fas fa-atom icon-sm"></i>
              <span class="pill">Môn</span>
            </div>
            <div class="subject-main">
              <div class="subject-name">Vật Lý</div>
              <div class="subject-sub">Vào chế độ</div>
            </div>
            <div class="subject-foot">
              <span class="subject-link">Mở</span>
              <i class="fas fa-arrow-right arrow"></i>
            </div>
          </div>

        </div>
      </div>

      <section id="recentHistoryPanel" class="recent-history glass-panel" aria-label="Lịch sử làm bài gần đây">
        <div class="rh-head">
          <div class="rh-title">Lịch sử làm bài gần đây</div>
          <div class="rh-sub">Hiển thị 3 lượt làm bài mới nhất trên hệ thống</div>
        </div>

        <div id="rhLoading" class="rh-loading">Đang tải...</div>

        <div id="rhEmpty" class="rh-empty hidden">
          Chưa có ai làm bài gần đây.
        </div>

        <div id="rhList" class="rh-list hidden"></div>
      </section>

    </main>
  </div>

  <style>
    :root {
      --bg: #050505;
      --surface: #121212;
      /* Tăng độ sáng viền lên để dễ nhìn hơn trên nền đen */
      --border: rgba(255,255,255,0.15); 
      --text-primary: #EDEDED;
      --text-secondary: #999999;
      --font-main: 'Inter', sans-serif;
      --ease-out: cubic-bezier(0.2, 0.8, 0.2, 1);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; outline: none; }

    body {
      background-color: var(--bg);
      color: var(--text-primary);
      font-family: var(--font-main);
      font-size: 14px;
      line-height: 1.4;
      opacity: 0;
      animation: pageIn 0.8s var(--ease-out) forwards;
    }

    @keyframes pageIn {
      from { opacity: 0; transform: scale(0.98); }
      to { opacity: 1; transform: scale(1); }
    }

    .app-container {
      max-width: 480px;
      margin: 0 auto;
      min-height: 100vh;
      position: relative;
      background: var(--bg);
    }

    .navbar {
      height: 60px;
      display: flex;
      align-items: center;
      padding: 0 20px;
      position: sticky;
      top: 0;
      z-index: 100;
      background: rgba(5,5,5,0.85);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border); /* Thêm lại viền mờ cho navbar */
      animation: slideDown 0.6s var(--ease-out) forwards;
    }

    @keyframes slideDown { from { transform: translateY(-100%); } to { transform: translateY(0); } }

    .nav-inner { width: 100%; display: flex; justify-content: space-between; align-items: center; }
    
    .nav-back {
      color: var(--text-primary);
      font-size: 18px;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      background: rgba(255,255,255,0.05); /* Tăng nhẹ nền nút back */
      transition: 0.2s;
      border: 1px solid rgba(255,255,255,0.05); /* Thêm viền nhẹ */
    }
    .nav-back:active { transform: scale(0.9); background: rgba(255,255,255,0.1); }

    .nav-title { font-weight: 700; font-size: 16px; letter-spacing: -0.01em; }
    .nav-placeholder { width: 40px; }

    .content { padding: 24px 20px; padding-bottom: 50px; }

    .header { margin: 30px 0; text-align: center; opacity: 0; animation: fadeUp 0.8s var(--ease-out) 0.1s forwards; }
    .header h1 { font-size: 26px; font-weight: 800; margin-bottom: 8px; letter-spacing: -0.5px; background: linear-gradient(to bottom, #fff, #aaa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .header p { color: var(--text-secondary); font-size: 14px; }

    .section { margin-bottom: 32px; opacity: 0; animation: fadeUp 0.8s var(--ease-out) 0.2s forwards; }
    .section-label { font-size: 11px; font-weight: 800; color: #666; letter-spacing: 2px; margin-bottom: 16px; text-transform: uppercase; padding-left: 5px; }

    .glass-panel {
      border-radius: 24px;
      padding: 20px;
      /* Tăng độ sáng nền và viền */
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      box-shadow: 0 20px 40px -10px rgba(0,0,0,0.5);
      opacity: 0; 
      animation: fadeUp 0.8s var(--ease-out) forwards;
    }

    @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    /* Leaderboard */
    .leaderboard .lb-head { display: flex; align-items: flex-end; justify-content: space-between; gap: 12px; margin-bottom: 16px; }
    .leaderboard .lb-title { font-size: 13px; letter-spacing: 0.05em; text-transform: uppercase; color: #fff; font-weight: 800; }
    .leaderboard .lb-sub { font-size: 12px; color: var(--text-secondary); }

    .lb-loading, .lb-empty { 
      padding: 30px; border-radius: 16px; 
      background: rgba(255,255,255,0.02); 
      border: 1px dashed var(--border); /* Thêm lại viền dashed */
      color: var(--text-secondary); font-size: 13px; text-align: center; 
    }
    .lb-list { display: flex; flex-direction: column; gap: 12px; }

    .lb-item {
      position: relative; display: flex; align-items: center; gap: 14px; padding: 14px;
      border-radius: 18px; 
      background: rgba(255,255,255,0.03); 
      border: 1px solid rgba(255,255,255,0.08); /* Viền item */
      overflow: hidden; transition: 0.3s;
    }
    .lb-item:hover { transform: translateY(-2px); background: rgba(255,255,255,0.06); border-color: rgba(255,255,255,0.15); }

    .rank-badge {
      width: 40px; height: 40px; border-radius: 12px; display: flex; align-items: center; justify-content: center;
      font-weight: 800; font-size: 16px; color: #fff; background: rgba(255,255,255,0.08);
      box-shadow: inset 0 0 10px rgba(255,255,255,0.05);
    }

    .lb-meta { flex: 1; min-width: 0; }
    .lb-name { font-weight: 700; font-size: 15px; color: #fff; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .lb-stats { font-size: 12px; color: var(--text-secondary); display: flex; align-items: center; gap: 8px; }
    .lb-medal { font-size: 10px; font-weight: 800; letter-spacing: 0.05em; text-transform: uppercase; color: #000; padding: 6px 10px; border-radius: 20px; background: #fff; flex-shrink: 0; box-shadow: 0 4px 10px rgba(255,255,255,0.2); }

    /* Top 1 Styling */
    .lb-item.r1 { 
      background: linear-gradient(135deg, rgba(255,215,0,0.1), rgba(0,0,0,0)); 
      border: 1px solid rgba(255,215,0,0.3); /* Viền vàng cho Top 1 */
    }
    .lb-item.r1 .rank-badge { background: linear-gradient(135deg, #FFD700, #FDB931); color: #000; text-shadow: 0 1px 0 rgba(255,255,255,0.4); }
    .lb-item.r1 .lb-medal { background: #FFD700; color: #000; box-shadow: 0 0 15px rgba(255,215,0,0.4); }

    /* Top 2 & 3 */
    .lb-item.r2 .rank-badge { background: linear-gradient(135deg, #E0E0E0, #BDBDBD); color: #000; }
    .lb-item.r3 .rank-badge { background: linear-gradient(135deg, #CD7F32, #A0522D); color: #000; }

    /* Subject Grid - SỬA ĐỔI ĐỂ ĐẢM BẢO 2 CỘT */
    .grid-subject { 
      display: grid; 
      grid-template-columns: 1fr 1fr; /* Luôn chia 2 cột đều nhau */
      gap: 15px; 
    }

    .subject-card {
      position: relative; overflow: hidden;
      border-radius: 24px; padding: 20px; cursor: pointer;
      /* Tăng độ sáng nền và viền */
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border);
      display: flex; flex-direction: column; justify-content: space-between; min-height: 160px;
      transition: all 0.4s var(--ease-out); backdrop-filter: blur(10px);
    }
    
    /* Shine Effect */
    .subject-card::before {
      content: ''; position: absolute; top: 0; left: -100%; width: 50%; height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.08), transparent);
      transform: skewX(-25deg); transition: 0s; pointer-events: none;
    }
    .subject-card:hover::before { left: 200%; transition: 0.7s; }

    .subject-card:hover { 
      transform: translateY(-5px); 
      background: rgba(255,255,255,0.08); 
      border-color: rgba(255,255,255,0.3); /* Viền sáng hơn khi hover */
      box-shadow: 0 15px 30px rgba(0,0,0,0.4); 
    }
    .subject-card:active { transform: scale(0.96); }

    .subject-top { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
    .icon-sm { font-size: 20px; color: #fff; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.1); border-radius: 10px; }
    .pill { font-size: 10px; font-weight: 700; letter-spacing: 0.05em; text-transform: uppercase; background: rgba(255,255,255,0.08); color: rgba(255,255,255,0.8); padding: 4px 8px; border-radius: 6px; }

    .subject-main { margin-top: auto; }
    .subject-name { font-size: 17px; font-weight: 700; color: #fff; margin-bottom: 2px; }
    .subject-sub { font-size: 12px; color: var(--text-secondary); transition: 0.3s; }
    .subject-card:hover .subject-sub { color: #fff; }

    .subject-foot { margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.06); display: flex; align-items: center; justify-content: space-between; color: var(--text-secondary); font-weight: 600; font-size: 12px; }
    .arrow { transition: 0.3s; opacity: 0.5; transform: translateX(-5px); }
    .subject-card:hover .arrow { opacity: 1; transform: translateX(0); color: #fff; }

    /* Recent History */
    .recent-history { margin-top: 20px; animation-delay: 0.3s; }
    .rh-head { display: flex; justify-content: space-between; align-items: baseline; gap: 8px; margin-bottom: 15px; }
    .rh-title { font-size: 13px; font-weight: 800; letter-spacing: 0.05em; text-transform: uppercase; color: #fff; }
    .rh-sub { font-size: 11px; color: var(--text-secondary); }

    .rh-loading, .rh-empty { 
      font-size: 13px; color: var(--text-secondary); padding: 20px; 
      border-radius: 12px; background: rgba(255,255,255,0.03); text-align: center;
      border: 1px dashed rgba(255,255,255,0.08); 
    }
    .rh-list { display: flex; flex-direction: column; gap: 8px; }

    .rh-item {
      display: flex; align-items: center; justify-content: space-between; gap: 12px;
      padding: 14px; border-radius: 14px; 
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.06); /* Viền nhẹ */
      transition: 0.2s;
    }
    .rh-item:hover { background: rgba(255,255,255,0.06); border-color: rgba(255,255,255,0.15); }

    .rh-main { flex: 1; min-width: 0; }
    .rh-name { font-size: 14px; font-weight: 600; color: #eee; margin-bottom: 2px; }
    .rh-subject { font-size: 12px; color: var(--text-secondary); }
    .rh-meta { text-align: right; font-size: 11px; color: #666; font-family: monospace; }
    .rh-dot { width: 8px; height: 8px; border-radius: 50%; background: #00ffb4; box-shadow: 0 0 10px #00ffb4; margin-right: 4px; }

    .hidden { display: none !important; }
  </style>

  <script>
    async function loadLeaderboard() {
      const loading = document.getElementById("lbLoading");
      const empty = document.getElementById("lbEmpty");
      const list = document.getElementById("lbList");

      try {
        loading.classList.remove("hidden");
        empty.classList.add("hidden");
        list.classList.add("hidden");
        list.innerHTML = "";

        const res = await fetch("/api/leaderboard?limit=3", { cache: "no-store" });
        if (!res.ok) throw new Error("leaderboard_fetch_failed");
        const data = await res.json();

        const top = data && data.top ? data.top : [];
        loading.classList.add("hidden");

        if (!top.length) {
          empty.classList.remove("hidden");
          return;
        }

        top.forEach((row, i) => {
          const rank = row.rank || i + 1;
          const name = row.displayName || "Ẩn danh";
          const attempts = row.attempts != null ? row.attempts : 0;
          const rate = row.aboveAvgRate != null ? row.aboveAvgRate : 0;

          const el = document.createElement("div");
          el.className = "lb-item r" + rank;
          el.style.animation = `fadeUp 0.6s ease-out ${i * 0.1}s forwards`; // Stagger animation
          el.style.opacity = '0'; // Start hidden for animation

          el.innerHTML =
            '<div class="lb-rank">' +
              '<div class="rank-badge">' + rank + "</div>" +
            "</div>" +
            '<div class="lb-meta">' +
              '<div class="lb-name" title="' + escapeHtml(name) + '">' + escapeHtml(name) + "</div>" +
              '<div class="lb-stats">' +
                "<span><b>" + attempts + "</b> lượt</span>" +
                '<span class="dot">•</span>' +
                "<span><b>" + Math.round(rate * 100) + "%</b> trên TB</span>" +
              "</div>" +
            "</div>" +
            '<div class="lb-medal">' + (rank === 1 ? "Vô địch" : rank === 2 ? "Á quân" : "Hạng ba") + "</div>";

          list.appendChild(el);
        });

        list.classList.remove("hidden");
      } catch (e) {
        loading.classList.add("hidden");
        empty.classList.remove("hidden");
        empty.textContent = "Không tải được bảng xếp hạng.";
      }
    }

    function modeKeyToSubject(modeKey) {
      if (!modeKey) return "Một bài kiểm tra";
      const k = String(modeKey).toLowerCase();
      if (k.includes("lich") || k.includes("history")) return "Lịch sử";
      if (k.includes("sinh") || k.includes("bio")) return "Sinh Học";
      if (k.includes("tin") || k.includes("it") || k.includes("info")) return "Tin Học";
      if (k.includes("anh") || k.includes("eng")) return "Tiếng Anh";
      if (k.includes("ly") || k.includes("phy")) return "Vật Lý"; // Thêm nhận diện môn Lý
      return "Một bài kiểm tra";
    }

    function formatTimeVN(iso) {
      if (!iso) return "";
      const d = new Date(iso);
      const now = new Date();

      const optTime = {
        hour: "2-digit",
        minute: "2-digit",
        hour12: false,
        timeZone: "Asia/Ho_Chi_Minh"
      };

      const optDate = {
        day: "2-digit",
        month: "2-digit",
        year: "numeric",
        timeZone: "Asia/Ho_Chi_Minh"
      };

      const timeStr = new Intl.DateTimeFormat("vi-VN", optTime).format(d);
      const dateStr = new Intl.DateTimeFormat("vi-VN", optDate).format(d);
      const isToday = d.toDateString() === now.toDateString();

      return (isToday ? "Hôm nay" : dateStr) + " · " + timeStr;
    }

    async function loadRecentHistory() {
      const panel = document.getElementById("recentHistoryPanel");
      const loading = document.getElementById("rhLoading");
      const empty = document.getElementById("rhEmpty");
      const list = document.getElementById("rhList");

      if (!panel || !loading || !empty || !list) return;

      try {
        loading.classList.remove("hidden");
        empty.classList.add("hidden");
        list.classList.add("hidden");
        list.innerHTML = "";

        const res = await fetch("/api/recent-attempts?limit=3", { cache: "no-store" });
        const data = await res.json();
        const items = data && Array.isArray(data.recent) ? data.recent : [];

        loading.classList.add("hidden");

        if (!items.length) {
          empty.classList.remove("hidden");
          return;
        }

        items.forEach((item, index) => {
          const name = escapeHtml(item.displayName || "Ẩn danh");
          const subject = escapeHtml(modeKeyToSubject(item.modeKey));
          const time = escapeHtml(formatTimeVN(item.createdAt));
          const score = item.score10 != null ? " · " + Number(item.score10).toFixed(1) + "/10" : "";

          const div = document.createElement("div");
          div.className = "rh-item";
          // Inline style for stagger animation
          div.style.animation = `fadeUp 0.5s ease-out ${index * 0.1}s forwards`;
          div.style.opacity = '0';

          div.innerHTML =
            '<div class="rh-dot"></div>' +
            '<div class="rh-main">' +
              '<div class="rh-name">' + name + "</div>" +
              '<div class="rh-subject">' + subject + score + "</div>" +
            "</div>" +
            '<div class="rh-meta">' + time + "</div>";

          div.dataset.index = String(index);
          list.appendChild(div);
        });

        list.classList.remove("hidden");
        // No observer needed, inline styles handle entrance
      } catch (err) {
        loading.classList.add("hidden");
        empty.classList.remove("hidden");
      }
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function goToSubject(url) {
        // Exit animation
        document.body.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
        document.body.style.opacity = '0';
        document.body.style.transform = 'scale(0.98)';
        
        setTimeout(() => {
            location.href = url;
        }, 300);
    }

    window.addEventListener("DOMContentLoaded", function () {
      loadLeaderboard();
      loadRecentHistory();
    });
  </script>
</body>
</html>
